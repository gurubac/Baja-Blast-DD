<!DOCTYPE html>
<html lang="en" style="color: rgb(0, 0, 0); font-family: Aclonica, sans-serif">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
  <title>Bajablast Down Detector</title>
  <link rel="stylesheet" type="text/css" href="../assets/bootstrap/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface&amp;display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Aclonica&amp;display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alatsi&amp;display=swap" />
  <link rel="stylesheet" type="text/css" href="../styles/gradient-navbar.css" />
  <link rel="stylesheet" type="text/css" href="../styles/Navbar---Logo-Middle---Phone-Logo-Middle.css" />
  <link rel="stylesheet" type="text/css" href="../styles/styles.css" />
  <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">  
</head>

<body style="
  display: flex;
  flex-direction : column;
  min-height: 100vh;
  color: #3b92c3;
  background: rgb(40, 44, 44);
  font-family: Alatsi, sans-serif;
  width: 100%; ">
 <%- include('partials/header') %>
  <div>
    <div style="width: 100%; height: 100%;">
      <h1 style="
            border-color: rgb(3, 252, 148);
            color: #f1de27;
            text-align: center;
            padding-top: 2%;
            height: 21%;
            width: 100%;
            font-size: 200%;
          ">
        Is the machine working?
      </h1>
    </div>
    <div style="height: 279%; width: 100%; text-align: center">
      <div class="table-responsive" style="height: 180px">
        <table class="table">
          <thead>
            <tr></tr>
          </thead>
          <tbody>
            <tr style="height: 50%">
              <td style="border-width: 0px; height: 80px">
                <% let addressURL=location.address %>
                  <button data-type="working" class="btn btn-primary, btn" type="button" id="yesButton" onclick="yesSubmit('<%= addressURL %>');"
                    style="
                      width: 61%;
                      background: rgb(3, 252, 148);
                      color: rgb(0, 0, 0);
                      border-radius: 100px;
                      padding: 0px 0px;
                      font-size: 169%;
                      margin-left: 1px;
                      height: 100%;
                      transform: scale(1);
                      letter-spacing: 1%;
                      border-width: 5px;
                      border-color: rgb(0, 0, 0);
                    ">
                    Working
                  </button>
              </td>
            </tr>
            <tr>
              <td style="border-width: 0px; height: 80px">
                <button data-type="not working" class="btn btn-primary, btn" type="button" id="noSubmit" onclick="noSubmit('<%= addressURL %>');"
                  style="
                      height: 100%;
                      width: 61%;
                      background: rgb(200, 13, 13);
                      font-size: 169%;
                      padding: 0px 0px;
                      margin-right: 0px;
                      border-radius: 100px;
                      margin-left: 1px;
                      transform: scale(1);
                      letter-spacing: 1%;
                      border-width: 5px;
                      border-color: rgb(0, 0, 0);
                    ">
                  Not Working
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div style="height: 100%; width: 100%; overflow: y-auto">
      <h1 style="
            text-align: center;
            color:  #f1de27;
            padding: 10px;
            width: 100%;
            height: 100%;
            font-size: 150%;
          ">
        <%= `${location.address}, ${location.city} ${location.state} ${location.zip}` %> </h1> 
        <h1 style="
        text-align: center;
        color:  #f1de27;
        font-size: 185%;
      ">
          Recent Results
      </h1>
      <div style="
            padding-top: 10px;
            height: 100%;
            width: 100%;
            letter-spacing: 0.5px;
          ">
        <% let filterLength=53 %>
          <% for (let i=location.comment.length - 1; i>= location.comment.length - filterLength && i >= 0; i--) { %>
            <% //machine working scenario%>
              <% if (location.comment[i].status=="WORKING" ) {%>
                <p
                  style="border: 3px solid rgb(68, 68, 68);background: #03fc94;border-top-left-radius: 10px;border-top-right-radius: 10px;border-bottom-right-radius: 10px;border-bottom-left-radius: 10px;color: rgb(0, 0, 0);text-align: center;margin: auto;width: 69%;letter-spacing: 0.5px;">
                  <%= `STATUS: ${location.comment[i].status} - ${location.comment[i].timestamp}`%>
                </p>
                <% } else if (location.comment[i].status=="NOT WORKING" ){ %>
                  <p
                    style=" background: #c80d0d; color: rgb(255, 255, 255); text-align: center;border-top-left-radius: 10px;border-top-right-radius: 10px;border-bottom-right-radius: 10px;border-bottom-left-radius: 10px;border: 3px solid rgb(68, 68, 68);width: 69%;height: 100%;margin: auto;letter-spacing: 0.5px">
                    <%= `STATUS: ${location.comment[i].status} - ${location.comment[i].timestamp}`%>
                  </p>
                  <% } %>
          <% } %>
      </div>
    </div>
  </div>
  </div>

  <%- include('partials/footer') %>
  <!-- scripts -->
  <script type = "text/js" src="/socket.io/socket.io.js"></script>
  <script src = "https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script> 
  <script type = "text/js" src="../assets/bootstrap/js/bootstrap.min.js"></script>
  
  <script>
    const baseURL = "https://bajablast.live"
    //const baseURL = "http://localhost:3000"
    async function yesSubmit(addressURL) {
      //console.log("yes button was clicked")
      let timestamp = moment(new Date()).format("h:mm:ss A - MMMM Do, YYYY");
      let status = "WORKING"
      let data = {
        timestamp: timestamp,
        status: status
      };
      await fetch(`${baseURL}/${addressURL}/info`, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'application/json'
        }
      })
        .then(response => response.json())
        .then(json => {
          //console.log(json)
          window.location = window.location;
        })
        .catch((err) => {
          console.log(err);
        });
    }

    async function noSubmit(addressURL) {
      //console.log("no button was clicked")
      let timestamp = moment(new Date()).format("h:mm:ss A - MMMM Do, YYYY");
      let status = "NOT WORKING"
      let data = {
        timestamp: timestamp,
        status: status
      };
      await fetch(`${baseURL}/${addressURL}/info`, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'application/json'
        }
      })
        .then(response => response.json())
        .then(json => {
          //console.log(json)
          window.location = window.location
        })
        .catch((err) => {
          console.log(err);
        });
    }
  </script>

  <!-- animation -->
  <script>
    function pop (e) {
    let amount = 25;
    switch (e.target.dataset.type) {
      case 'shadow':
      case 'line':
        amount = 1;
        break;
    }
    // Quick check if user clicked the button using a keyboard
    if (e.clientX === 0 && e.clientY === 0) {
      const bbox = e.target.getBoundingClientRect();
      const x = bbox.left + bbox.width / 2;
      const y = bbox.top + bbox.height / 2;
      for (let i = 0; i < 30; i++) {
        // We call the function createParticle 30 times
        // We pass the coordinates of the button for x & y values
        createParticle(x, y, e.target.dataset.type);
      }
    } else {
      for (let i = 0; i < amount; i++) {
        createParticle(e.clientX, e.clientY + window.scrollY, e.target.dataset.type);
      }
    }
  }

  function createParticle (x, y, type) {
    const particle = document.createElement('particle');
    document.body.appendChild(particle);
    let width = Math.floor(Math.random() * 30 + 8);
    let height = width;
    let destinationX = (Math.random() - 0.5) * 300;
    let destinationY = (Math.random() - 0.5) * 300;
    let rotation = Math.random() * 1;
    let delay = Math.random() * 200;
    
    switch (type) {
      case 'working':
        particle.style.backgroundImage = 'url(https://cdn.shopify.com/s/files/1/1061/1924/products/Thumbs_Up_Sign_Emoji_Icon_ios10_large.png?v=1571606114)';
        break;
      case 'not working':
        particle.style.backgroundImage = 'url(https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/apple/285/crying-face_1f622.png)';
        break;
    }
    
    particle.style.width = `${width*2}px` ;
    particle.style.height = `${height*2}px`;
    const animation = particle.animate([
      {
        transform: `translate(-50%, -50%) translate(${x}px, ${y}px) rotate(0deg)`,
        opacity: 1
      },
      {
        transform: `translate(-50%, -50%) translate(${x + destinationX}px, ${y + destinationY}px) rotate(${rotation}deg)`,
        opacity: 0
      }
    ], {
      duration: Math.random() * 1000 + 5000,
      easing: 'cubic-bezier(0, .9, .57, 1)',
      delay: delay
    });
    animation.onfinish = removeParticle;
  }
  function removeParticle (e) {
    e.srcElement.effect.target.remove();
  }

  if (document.body.animate) {
    document.querySelectorAll('button').forEach(button => button.addEventListener('click', pop));
  }
  </script>
</body>
</html>